---
const { alt = "", file } = Astro.props;
---

<protected-image class="w-full" {file}>
  <img class="protected blur-xl" {alt} />
</protected-image>

<script>
  import { supabase } from "../lib/supabase";

  class ProtectedImage extends HTMLElement {
    constructor() {
      super();
    }

    async connectedCallback() {
      const width = this.offsetWidth;

      const { data, error } = await supabase.storage
        .from("site_assets")
        .createSignedUrl(this.getAttribute("file"), 10, {
          transform: {
            width,
            resize: "contain",
          },
        });

      const img = this.querySelector("img");
      img.setAttribute("src", data.signedUrl);
      img.setAttribute("width", width.toString());

      img.addEventListener("contextmenu", (e) => e.preventDefault());
      img.addEventListener("dragstart", (e) => e.preventDefault());
    }
  }

  customElements.define("protected-image", ProtectedImage);
</script>
